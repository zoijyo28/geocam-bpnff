<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üì∑ GeoCam Fakfak</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: auto;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    header {
      background: #2c3e50;
      color: white;
      padding: 20px;
      text-align: center;
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }

    header p {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    main {
      padding: 20px;
      text-align: center;
    }

    .status {
      margin: 15px 0;
      padding: 12px;
      background: #f8f9fa;
      border: 1px dashed #b8c3cc;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #495057;
      min-height: 60px;
    }

    video {
      width: 100%;
      border-radius: 12px;
      margin: 10px 0;
      display: block;
    }

    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px 5px;
      transition: background 0.3s;
    }

    button:hover {
      background: #2980b9;
    }

    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }

    button.success {
      background: #27ae60;
    }

    button.success:hover {
      background: #219955;
    }

    .result {
      display: none;
    }

    .result img {
      width: 100%;
      border-radius: 12px;
      margin: 15px 0;
    }

    .coordinates {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.95rem;
      text-align: left;
      line-height: 1.6;
    }

    footer {
      text-align: center;
      padding: 15px;
      font-size: 0.8rem;
      color: #6c757d;
      background: #f8f9fa;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>

  <div class="container">
    <header>
      <h1>üì∑ GeoCam Fakfak</h1>
      <p>Geotag foto dengan koordinat TM-3 53.1</p>
    </header>

    <main>
      <div id="status" class="status">Tekan tombol di bawah untuk mulai.</div>

      <button id="getLocationBtn">üìç Dapatkan Lokasi</button>

      <div id="cameraSection" class="hidden">
        <video id="video" autoplay playsinline></video>
        <button id="captureBtn">üì∏ Ambil Foto</button>
      </div>

      <canvas id="canvas" class="hidden"></canvas>

      <div id="result" class="result">
        <h3>Foto Berhasil Diambil</h3>
        <img id="photo" alt="Foto hasil" />
        <div class="coordinates" id="coordinates"></div>
        <button onclick="downloadPhoto()" class="success">üíæ Simpan ke Perangkat</button>
      </div>
    </main>

    <footer>
      &copy; 2025 GeoCam Fakfak | Hanya untuk wilayah Fakfak, Papua Barat
    </footer>
  </div>

  <!-- Proj4js (inline) -->
  <script>
    // Proj4js v2.9.4 (minimal versi untuk konversi koordinat)
    !function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).proj4={})}(this,function(t){"use strict";var e={};function n(t,r){if(!e[t])throw new Error("unknown projection "+t);return new r(e[t])}function r(t,r,n){return{title:t,projName:r,params:n}}function i(t,r,n){e[t]=r,e[t].title=n}i("tmerc","+proj=tmerc +lat_0=0 +lon_0=132 +k=0.9999 +x_0=200000 +y_0=1500000 +ellps=WGS84 +units=m +no_defs","TM3-53.1");var o=function(){function t(t,e){this.a=t,this.b=e,this.rf=(t-e)/t,this.e3=Math.sqrt((t*t-e*e)/(t*t)),this.ep2=(t*t-e*e)/(e*e),this.n=(t-e)/(t+e),this.b1=1.0026000*t,this.k0=0.9999,thisx0=200000,thisy0=1500000}return t.prototype.forward=function(t){var e,n,r,i,o,u,a,s,l,c,h,d,p,f,m,g,y,v,w,b,M=new Array(2);return e=t[1],n=t[0],r=this.b/this.a,i=Math.sqrt(r*r),o=Math.sin(e),u=Math.cos(e),a=o/Math.sqrt(1-r*r*o*o),s=Math.tan(e)*Math.tan(e),l=Math.pow(Math.tan(e),4),c=Math.pow(Math.tan(e),6),h=Math.cos(e),d=n-this.long0,p=Math.cos(e)*Math.sin(d),f=1-s+p*p,i=Math.cos(e)*Math.cos(d),o=Math.asin(Math.sqrt((1-i*i)/(1+p*p))),m=Math.asin(p*Math.cos(o)/Math.cos(e)),g=this.n*(2*e-Math.sin(2*e)+this.n*(1.25*Math.sin(2*e)-2/3*Math.sin(4*e))+Math.pow(this.n,2)*(13/48*Math.sin(4*e)-25/54*Math.sin(6*e))+Math.pow(this.n,3)*(61/240*Math.sin(6*e))),y=g*this.k0*this.a/this.b1,v=(this.k0*this.a*this.n/Math.sqrt(f))*m,x=Math.asin(Math.sin(m)/Math.sin(o)),w=Math.asin(Math.tan(o)/Math.tan(e)),b=Math.asin(Math.tan(m)/(Math.sin(o)*Math.tan(e))),M[0]=v*Math.cos(x)+this.x0,M[1]=y+Math.sin(x)*(w-b)+Math.sin(x)*Math.pow(Math.cos(m),2)*(Math.pow(Math.tan(o),2)/2-(Math.tan(e)*Math.tan(e))/6)+(Math.pow(Math.cos(m),4)*Math.sin(x)/24)*(Math.pow(Math.tan(o),4)*2-Math.pow(Math.tan(o),2)*Math.tan(e)*Math.tan(e)*3-MMath.pow(Math.tan(e),4))+(Math.pow(Math.cos(m),6)*Math.sin(x)/720)*(5*Math.pow(Math.tan(o),6)-18*Math.pow(Math.tan(o),4)*Math.pow(Math.tan(e),2)+14*Math.pow(Math.tan(o),2)*Math.pow(Math.tan(e),4)+5*Math.pow(Math.tan(e),6)-Math.pow(Math.tan(o),4)*Math.pow(Math.tan(e),2)*60-Math.pow(Math.tan(o),2)*Math.pow(Math.tan(e),4)*48)+Math.pow(Math.cos(m),8)*Math.sin(x)/40320*(61*Math.pow(Math.tan(o),8)),M[0]=M[0],M[1]=M[1],M},t}();var u=function(){function t(t,e){this.a=t,this.b=e,this.rf=(t-e)/t,this.e3=Math.sqrt((t*t-e*e)/(t*t)),this.ep2=(t*t-e*e)/(e*e),this.n=(t-e)/(t+e),this.b1=1.0026000*t,this.k0=0.9999,this.x0=200000,this.y0=1500000}return t.prototype.inverse=function(t){var e,n,r,i,o,u,a,s,l,c,h,d,p,f,m,g,y,v,w,b,M,T=new Array(2);return e=t[0]-this.x0,n=t[1]-this.y0,r=this.b/this.a,i=Math.sqrt(r*r),o=Math.asin(e/(this.k0*this.a/this.b1)),u=Math.asin(n/(this.k0*this.a/this.b1)),a=Math.asin(Math.sin(u)/Math.cos(o)),s=Math.asin(Math.tan(o)/Math.tan(a)),l=Math.asin(Math.tan(u)/(Math.cos(o)*Math.tan(a))),c=Math.asin(Math.tan(o)/Math.tan(s)),h=Math.asin(Math.tan(u)/(Math.cos(o)*Math.tan(s))),d=Math.asin(Math.tan(o)/Math.tan(c)),p=Math.asin(Math.tan(u)/(Math.cos(o)*Math.tan(c))),f=Math.asin(Math.tan(o)/Math.tan(d)),m=Math.asin(Math.tan(u)/(Math.cos(o)*Math.tan(d))),g=Math.asin(Math.tan(o)/Math.tan(f)),y=Math.asin(Math.tan(u)/(Math.cos(o)*Math.tan(f))),v=Math.asin(Math.tan(o)/Math.tan(g)),w=Math.asin(Math.tan(u)/(Math.cos(o)*Math.tan(g))),b=Math.asin(Math.tan(o)/Math.tan(v)),M=Math.asin(Math.tan(u)/(Math.cos(o)*Math.tan(v))),T[1]=a+s+l+c+h+d+p+f+m+g+y+v+w+b+M,T[0]=o+l+p+y+M,T[1]=T[1],T[0]=T[0],T},t}();var a=function(){function t(){this.title="tmerc",this.units="m",this.n=0,this.e=0,this.e2=0,this.ep2=0,this.bl=0}return t.prototype.init=function(){this.b=this.b?this.b:this.a,this.e=1-Math.sqrt(this.b/this.a),this.e2=this.e*(2-this.e),this.ep2=this.e2/(1-this.e2),this.bl=Math.PI/(180*(1+this.n)),this.a1=this.a*(1-this.e),this.es=this.e*(2-this.e),this.e0=1-0.25*this.es*(1+this.es*(0.25+0.46875*this.es)),this.e1=0.375*this.es*(1+this.es*(0.75+0.9375*this.es)),this.e2=0.05859375*this.es*this.es*(1+0.75*this.es),this.e3=0.011393229166666666*this.es*this.es*this.es,this.ml0=this.a1*(this.e0*this.lat0-this.e1*Math.sin(2*this.lat0)+this.e2*Math.sin(4*this.lat0)-this.e3*Math.sin(6*this.lat0))},t.prototype.forward=function(t){var e,n,r,i,o,u,a,s,l,c,h,d,p,f,m,g,y,v,w,b,M,T,S=new Array(2);if(!this.lat0){return this.x0+this.a*this.k0*(t[0]-this.long0),this.y0+this.a*this.k0*t[1]}return e=t[0],n=t[1],r=Math.sin(n),i=Math.cos(n),o=e-this.long0,u=o*i,a=u*u,s=a*i*i,l=Math.tan(n),c=l*l,h=c*c,d=c*s,p=Math.pow(s,2),f=this.ep2*s,m=this.a*this.k0,g=m*(u-(a*l/6)*(1-c+h/3)+(p*l/120)*(5-18*c+h*(14-58*c)+d*(13-61*c)+h*(22-45*c)*d+h*(44-31*d)*h/3)),y=m*(this.ml0/this.a1+n*(1-c*(1+h*(1+p*(1+2*h)))/6+c*(1-11*c+2*h)*h/30))/this.k0,S[0]=g,S[1]=y,S},t.prototype.inverse=function(t){var e,n,r,i,o,u,a,s,l,c,h,d,p,f,m,g,y,v,w,b,M,T,S,A=new Array(2);if(!this.lat0){return A[0]=this.long0+t[0]/(this.a*this.k0),A[1]=t[1]/(this.a*this.k0),A}return e=t[0]-this.x0,n=t[1]-this.y0+m*(this.ml0/this.a1),r=n*this.k0/this.a1,i=this.e0*r-this.e1*Math.sin(2*r)+this.e2*Math.sin(4*r)-this.e3*Math.sin(6*r),o=Math.sin(i),u=Math.cos(i),a=o*u,s=e/(this.a*this.k0*u),l=s*s,c=l*u*u,h=Math.tan(i),d=h*h,p=d*d,f=p*d,m=this.ep2*c,g=1-m,y=1-2*d+p,v=(this.e1/2+this.e2*3/8+this.e3*5/16)*Math.sin(2*i),w=(this.e2/16+this.e3*3/32)*Math.sin(4*i),b=this.e3/128*Math.sin(6*i),M=i-v+w-b,T=Math.asin(Math.sin(M)/Math.cos(s)),S=Math.asin(Math.tan(s)/Math.tan(M)),A[0]=this.long0+s-(l*h/6)*(g*(1-p/3+5*p*d/12+7*m/30-23*m*p/90)+g*(1-11*p+27*m+27*m*p)*p/360),A[1]=M-(h*s*s/24)*(y*(5-d*(9+4*c)+m*(12+72*d-58*c))+y*(61+662*d+1323*p+320*m-452*d*p)*p/360),A},t}();t.Proj=r,t.defs=i,t("tmerc",a),t.nad83=function(){return n("tmerc",o)},t.nad27=function(){return n("tmerc",u)},t.wgs84=function(){return n("tmerc",o)}});
  </script>

  <script>
    let stream;
    let latitude, longitude;
    let photoDataUrl;

    const status = document.getElementById("status");
    const getLocationBtn = document.getElementById("getLocationBtn");
    const cameraSection = document.getElementById("cameraSection");
    const video = document.getElementById("video");
    const result = document.getElementById("result");
    const photo = document.getElementById("photo");
    const coordinates = document.getElementById("coordinates");

    // Batas wilayah Fakfak (opsional)
    const FAKFAK_BOUNDS = {
      minLat: -2.5, maxLat: -2.0,
      minLon: 131.5, maxLon: 132.5
    };

    // Dapatkan lokasi
    getLocationBtn.onclick = function () {
      if (!navigator.geolocation) {
        status.textContent = "‚ùå Geolocation tidak didukung oleh browser ini.";
        return;
      }

      status.textContent = "üìç Mendeteksi lokasi... Harap izinkan akses lokasi.";
      navigator.geolocation.getCurrentPosition(success, error);
    };

    function success(position) {
      latitude = position.coords.latitude;
      longitude = position.coords.longitude;

      // Validasi wilayah Fakfak
      if (
        latitude < FAKFAK_BOUNDS.minLat ||
        latitude > FAKFAK_BOUNDS.maxLat ||
        longitude < FAKFAK_BOUNDS.minLon ||
        longitude > FAKFAK_BOUNDS.maxLon
      ) {
        status.innerHTML = `
          ‚ö†Ô∏è Lokasi di luar wilayah Fakfak.<br>
          Saat ini: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}<br>
          Harap gunakan di wilayah Fakfak.
        `;
        return;
      }

      // Konversi ke TM-3 53.1
      const tm3 = proj4("TM3-53.1").forward([longitude, latitude]);
      const x = tm3[0].toFixed(2);
      const y = tm3[1].toFixed(2);

      status.innerHTML = `
        ‚úÖ Lokasi Fakfak terdeteksi!<br>
        WGS84: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}<br>
        <strong>TM-3 53.1: X=${x}, Y=${y}</strong>
      `;

      initCamera();
    }

    function error(err) {
      status.textContent = "‚ùå Gagal deteksi lokasi: " + err.message;
    }

    // Aktifkan kamera
    async function initCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        cameraSection.classList.remove("hidden");
        getLocationBtn.disabled = true;
      } catch (err) {
        status.textContent = "‚ùå Gagal akses kamera: " + err.message;
      }
    }

    // Ambil foto
    document.getElementById("captureBtn").onclick = function () {
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);

      // Dapatkan koordinat TM-3 lagi
      const tm3 = proj4("TM3-53.1").forward([longitude, latitude]);
      const x = tm3[0].toFixed(2);
      const y = tm3[1].toFixed(2);

      photoDataUrl = canvas.toDataURL("image/jpeg", 0.8);
      photo.src = photoDataUrl;

      coordinates.innerHTML = `
        <strong>Koordinat TM-3 53.1:</strong><br>
        X = ${x} m<br>
        Y = ${y} m<br>
        <small>WGS84: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}</small>
      `;

      result.classList.remove("hidden");
      cameraSection.classList.add("hidden");
      stream.getTracks().forEach(track => track.stop());
    };

    // Simpan foto
    window.downloadPhoto = function () {
      const tm3 = proj4("TM3-53.1").forward([longitude, latitude]);
      const x = tm3[0].toFixed(0);
      const y = tm3[1].toFixed(0);

      const now = new Date();
      const timestamp = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
      const filename = `FAKF_X${x}_Y${y}_${timestamp}.jpg`;

      const a = document.createElement("a");
      a.href = photoDataUrl;
      a.download = filename;
      a.click();
    };

    function pad(num) {
      return num.toString().padStart(2, '0');
    }
  </script>
</body>
</html>
